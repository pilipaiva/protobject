<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>C√°mara Lector ArUco</title>

    <style>
      body {
        margin: 0;
        background: black;
        overflow: hidden;
      }

      #status {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 8px;
        background: rgba(0,0,0,0.6);
        color: white;
        font-family: sans-serif;
        font-size: 16px;
        z-index: 10;
      }

      #startBtn {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        background: #007bff;
        color: white;
        font-size: 16px;
        font-family: sans-serif;
        z-index: 20;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="status">Toca el bot√≥n para iniciar la c√°mara.</div>
    <button id="startBtn">Iniciar c√°mara</button>

    <!-- Protobject framework -->
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <script>
  const statusDiv = document.getElementById("status");
  const startBtn  = document.getElementById("startBtn");

  function initAruco() {
    startBtn.style.display = "none";
    statusDiv.textContent  = "Inicializando c√°mara...";

    // 1) Iniciar la detecci√≥n ArUco con la c√°mara 0
    try {
      Protobject.Aruco.start(60, 0);  // üëà c√°mara por defecto
      console.log("‚úÖ ArUco start(60, 0)");
    } catch (e) {
      console.error("‚ùå No se pudo iniciar ArUco:", e);
      statusDiv.textContent = "No se pudo iniciar la c√°mara. Revisa permisos.";
      statusDiv.style.background = "rgba(128,0,0,0.8)";
      return;
    }

    // 2) Intentar MOSTRAR la vista previa de la c√°mara
    //    Si esto se rompe, lo ignoramos y seguimos solo con la detecci√≥n.
    try {
      Protobject.Aruco.showPreview({
        top: 0,
        left: 0,
        width: window.innerWidth,
        height: window.innerHeight
      });
      console.log("‚úÖ showPreview OK");
    } catch (ePreview) {
      console.warn("‚ö†Ô∏è No se pudo mostrar la vista previa (pero la detecci√≥n sigue):", ePreview);
      // NO hacemos return aqu√≠: seguimos sin preview
    }

    statusDiv.textContent = "C√°mara lista, apunta un c√≥digo ArUco.";
    statusDiv.style.background = "rgba(0,0,0,0.6)";

    // 3) Callback de detecci√≥n
    Protobject.Aruco.onData((data) => {
      const ids = Object.keys(data).map(id => Number(id));
      console.log("üì∑ ArUco data:", data, "IDs:", ids);

      if (ids.length > 0) {
        playAudioForArucoIDs(ids);              // üëà sonido AHORA desde la c√°mara
        Protobject.Core.send(ids).to("index.html");
        statusDiv.textContent = "Detectado: " + ids.join(", ");
        statusDiv.style.background = "rgba(0,128,0,0.6)";
      } else {
        Protobject.Core.send([]).to("index.html");
        statusDiv.textContent = "No se detectan c√≥digos.";
        statusDiv.style.background = "rgba(0,0,0,0.6)";
      }
    });

      // ================= AUDIO VAN GOGH EN LA C√ÅMARA =================

  // Necesitamos tambi√©n el JSON aqu√≠ para saber el Year
  let data_van_gogh = [];
  let isDataLoaded  = false;

  fetch('van_gogh_filtrado.json')
    .then(r => r.json())
    .then(d => {
      data_van_gogh = d;
      isDataLoaded  = true;
      console.log("‚úÖ JSON audio cargado en camara.html");
    })
    .catch(e => console.error("Error JSON audio (camara):", e));

// Cach√© para evitar repetir sonidos
  let lastAudioKey = "";

  // Reproductor de audio
  const audioPlayer = new Audio();
  audioPlayer.volume = 1.0;

  // Funci√≥n: seg√∫n el a√±o devuelve qu√© audio debe sonar
  function getAudioForYear(year) {
    if (year === 1885) return "1885.MP3";
    if (year === 1886) return "1886.MP3";
    if (year === 1887) return "1887.MP3";
    if (year === 1888) return "1888.MP3";
    if (year === 1889) return "1889.MP3";
    if (year === 1890) return "1890.MP3";
    // Si quieres un default:
    // return "default.MP3";
  }

  // Funci√≥n principal: revisa los IDs detectados y dispara audio
  function playAudioForArucoIDs(ids) {
    if (!isDataLoaded || ids.length === 0) return;

    // Encontrar artworks seg√∫n los IDs
    const artworks = ids.map(id =>
      data_van_gogh.find(item => Number(item.ArucoID) === Number(id))
    ).filter(Boolean);

    if (artworks.length === 0) return;

    // Tomamos el a√±o M√ÅS ANTIGUO como referencia
    const year = Math.min(...artworks.map(a => a.Year));
    const audioSrc = getAudioForYear(year);
    if (!audioSrc) return;

    // Evitar repetir sonido si es la misma combinaci√≥n
    const newKey = ids.slice().sort((a,b)=>a-b).join(",") + "-" + year;
    if (newKey === lastAudioKey) return;
    lastAudioKey = newKey;

    audioPlayer.src = audioSrc;
    audioPlayer.play().catch(err => {
      console.warn("‚ö†Ô∏è No se pudo reproducir audio:", err);
    });
  }

  }


  startBtn.addEventListener("click", initAruco);
</script>

  </body>
</html>
